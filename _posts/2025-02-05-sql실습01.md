---
layout : post
title : "Mysql Ïã§Ïäµ 01"

categories:
  - sql
tags:
  - [sql, mysql]

toc: true
toc_sticky: true
 
date: 2025-02-05 15:52:00 +0900
---
```sql
use analyze_db;

SELECT * FROM TB_POPLTN_DATA; # Data Warehouse
```

```sql
-- Ïª¨Îüº Î†àÎ≤®Ïóê ÏßëÍ≥ÑÏùò Í∏∞Ï§ÄÏù¥ ÏûàÏúºÎ©¥ Í∑∏ Îç∞Ïù¥ÌÑ∞Îäî ÏßëÍ≥ÑÍ∞Ä Î∂àÍ∞ÄÎä•!!!
-- Ïª¨ÎüºÏùÄ Ìï≠Î™©ÏùÑ Î∂ÑÎ•òÌïòÍ∏∞ ÏúÑÌï¥ ÎßåÎìúÎäî Í±∞ÏßÄ !! 

INSERT INTO TB_POPLTN
SELECT A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.STD_MT
     , CASE WHEN LVL1 = 1 THEN 'M' WHEN LVL1 = 2 THEN 'F' WHEN LVL1 = 3 THEN 'T' END AS POPLTN_SE_CD
     , CASE WHEN LVL2 = 1  THEN '000' WHEN LVL2 = 2  THEN '010' WHEN LVL2 = 3  THEN '020'
            WHEN LVL2 = 4  THEN '030' WHEN LVL2 = 5  THEN '040' WHEN LVL2 = 6  THEN '050'
            WHEN LVL2 = 7  THEN '060' WHEN LVL2 = 8  THEN '070' WHEN LVL2 = 9  THEN '080' WHEN LVL2 = 10 THEN '090' WHEN LVL2 = 11 THEN '100' END AS AGRDE_SE_CD
     , CASE WHEN LVL1 = 1 AND LVL2 = 1  THEN MALE_POPLTN_CO_0_9     WHEN LVL1 = 1 AND LVL2 = 2  THEN MALE_POPLTN_CO_10_19
            WHEN LVL1 = 1 AND LVL2 = 3  THEN MALE_POPLTN_CO_20_29   WHEN LVL1 = 1 AND LVL2 = 4  THEN MALE_POPLTN_CO_30_39
            WHEN LVL1 = 1 AND LVL2 = 5  THEN MALE_POPLTN_CO_40_49   WHEN LVL1 = 1 AND LVL2 = 6  THEN MALE_POPLTN_CO_50_59
            WHEN LVL1 = 1 AND LVL2 = 7  THEN MALE_POPLTN_CO_60_69   WHEN LVL1 = 1 AND LVL2 = 8  THEN MALE_POPLTN_CO_70_79
            WHEN LVL1 = 1 AND LVL2 = 9  THEN MALE_POPLTN_CO_80_89   WHEN LVL1 = 1 AND LVL2 = 10 THEN MALE_POPLTN_CO_90_99
            WHEN LVL1 = 1 AND LVL2 = 11 THEN MALE_POPLTN_CO_100     WHEN LVL1 = 2 AND LVL2 = 1  THEN FEMALE_POPLTN_CO_0_9
            WHEN LVL1 = 2 AND LVL2 = 2  THEN FEMALE_POPLTN_CO_10_19 WHEN LVL1 = 2 AND LVL2 = 3  THEN FEMALE_POPLTN_CO_20_29
            WHEN LVL1 = 2 AND LVL2 = 4  THEN FEMALE_POPLTN_CO_30_39 WHEN LVL1 = 2 AND LVL2 = 5  THEN FEMALE_POPLTN_CO_40_49
            WHEN LVL1 = 2 AND LVL2 = 6  THEN FEMALE_POPLTN_CO_50_59 WHEN LVL1 = 2 AND LVL2 = 7  THEN FEMALE_POPLTN_CO_60_69
            WHEN LVL1 = 2 AND LVL2 = 8  THEN FEMALE_POPLTN_CO_70_79 WHEN LVL1 = 2 AND LVL2 = 9  THEN FEMALE_POPLTN_CO_80_89
            WHEN LVL1 = 2 AND LVL2 = 10 THEN FEMALE_POPLTN_CO_90_99 WHEN LVL1 = 2 AND LVL2 = 11 THEN FEMALE_POPLTN_CO_100
            WHEN LVL1 = 3 AND LVL2 = 1  THEN POPLTN_CO_0_9          WHEN LVL1 = 3 AND LVL2 = 2  THEN POPLTN_CO_10_19
            WHEN LVL1 = 3 AND LVL2 = 3  THEN POPLTN_CO_20_29        WHEN LVL1 = 3 AND LVL2 = 4  THEN POPLTN_CO_30_39
            WHEN LVL1 = 3 AND LVL2 = 5  THEN POPLTN_CO_40_49        WHEN LVL1 = 3 AND LVL2 = 6  THEN POPLTN_CO_50_59
            WHEN LVL1 = 3 AND LVL2 = 7  THEN POPLTN_CO_60_69        WHEN LVL1 = 3 AND LVL2 = 8  THEN POPLTN_CO_70_79
            WHEN LVL1 = 3 AND LVL2 = 9  THEN POPLTN_CO_80_89        WHEN LVL1 = 3 AND LVL2 = 10 THEN POPLTN_CO_90_99
            WHEN LVL1 = 3 AND LVL2 = 11 THEN POPLTN_CO_100 END AS POPLTN_CNT
  FROM
     (
      SELECT SUBSTR(ADMINIST_ZONE, INSTR(ADMINIST_ZONE, '(') + 1, 10) AS ADMINIST_ZONE_NO
           , SUBSTR(ADMINIST_ZONE, 1, INSTR(ADMINIST_ZONE, '(')-1) AS ADMINIST_ZONE_NM,
             '202304' AS STD_MT
           , MALE_POPLTN_CO_0_9    , MALE_POPLTN_CO_10_19  , MALE_POPLTN_CO_20_29
           , MALE_POPLTN_CO_30_39  , MALE_POPLTN_CO_40_49  , MALE_POPLTN_CO_50_59
           , MALE_POPLTN_CO_60_69  , MALE_POPLTN_CO_70_79  , MALE_POPLTN_CO_80_89  , MALE_POPLTN_CO_90_99  , MALE_POPLTN_CO_100
           , FEMALE_POPLTN_CO_0_9  , FEMALE_POPLTN_CO_10_19, FEMALE_POPLTN_CO_20_29
           , FEMALE_POPLTN_CO_30_39, FEMALE_POPLTN_CO_40_49, FEMALE_POPLTN_CO_50_59
           , FEMALE_POPLTN_CO_60_69, FEMALE_POPLTN_CO_70_79, FEMALE_POPLTN_CO_80_89, FEMALE_POPLTN_CO_90_99, FEMALE_POPLTN_CO_100
           , POPLTN_CO_0_9         , POPLTN_CO_10_19, POPLTN_CO_20_29
           , POPLTN_CO_30_39       , POPLTN_CO_40_49, POPLTN_CO_50_59
           , POPLTN_CO_60_69       , POPLTN_CO_70_79, POPLTN_CO_80_89, POPLTN_CO_90_99, POPLTN_CO_100
           , LVL1, LVL2
        FROM TB_POPLTN_DATA,
		(SELECT (tmp1.idx) AS LVL1 
		FROM (SELECT 1 as idx UNION SELECT 2 UNION SELECT 3) tmp1) LVL1, (SELECT (tmp2.idx) AS LVL2 
		FROM (SELECT 1 as idx UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10 UNION SELECT 11) tmp2) LVL2
     ) A ;

-- UNIONÏùÑ ÌÜµÌï¥ Î†àÎ≤®ÏùÑ ÏÑ§Ï†ï
-- 1~3 Î†àÎ≤® (LV1) : ÏÑ±Î≥ÑÏùÑ ÏùòÎØ∏ ( ÎÇ® / Ïó¨ / Ï†ÑÏ≤¥)
-- 1~11 Î†àÎ≤® (LV2) : ÎÇòÏù¥ÎåÄÎ•º ÏùòÎØ∏ 

-- Ïπ¥Î•¥ÌÖåÏãúÏïà JOIN
-- meltingÏùÑ ÏãúÏºúÏïºÌï† Îïå ÌÅ¨Î°úÏä§Ï°∞Ïù∏Ïù¥ ÌïÑÏöîÌïòÎã§.
```
## UNION
- UNIONÏùÄ Ïó¨Îü¨ Í∞úÏùò SELECT Í≤∞Í≥ºÎ•º "ÏÑ∏Î°ú"Î°ú ÏßëÌï©ÌïòÎäî Ïó∞ÏÇ∞Ïûê

  ```sql
	(SELECT (tmp1.idx) AS LVL1 
		FROM (SELECT 1 as idx UNION SELECT 2 UNION SELECT 3) tmp1) LVL1, (SELECT (tmp2.idx) AS LVL2 
		FROM (SELECT 1 as idx UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10 UNION SELECT 11) tmp2) LVL2
  ```
**ÏúÑ ÏΩîÎìú Ìï¥ÏÑù**

![](/images/../images/2025-02-07-15-44-26.png)
*gptÎäî Î©ãÏüÅÏù¥ ÏÑ†ÏÉùÎãòÏù¥ÏóêÏò§,,,*

```sql
SELECT * FROM TB_POPLTN;

SELECT * FROM TB_POPLTN WHERE ADMINIST_ZONE_NM LIKE 'ÎåÄÍµ¨%'
```

```sql
-- Ï†ÑÏ≤¥ Ïù∏Íµ¨Ïùò Ïó∞Î†πÎåÄÎ≥Ñ ÎπÑÏú® Íµ¨ÌïòÍ∏∞
-- 2023ÎÖÑ 4Ïõî Í∏∞Ï§Ä Ï†ÑÍµ≠ Ïãú/ÎèÑ Í∏∞Ï§Ä Ïó∞Î†πÎåÄÎ≥Ñ Ïù∏Íµ¨Ïàò Ìï©Í≥Ñ
SELECT 
	AGRDE_SE_CD,
	SUM(POPLTN_CNT) AS AGRDE_POPLTN_CNT
FROM TB_POPLTN
WHERE STD_MT='202304'
	AND ADMINIST_ZONE_NO LIKE '__00000000'
	AND POPLTN_SE_CD = 'T'
GROUP BY AGRDE_SE_CD
ORDER BY AGRDE_SE_CD;
```

```sql
-- 2023ÎÖÑ 4Ïõî Í∏∞Ï§Ä Ï†ÑÍµ≠ Ï£ºÏöî Ïãú/ÎèÑÏùò Ïó∞Î†πÎåÄÎ≥Ñ Ïù∏Íµ¨ÏàòÎ•º Íµ¨ÌïòÍ≥†, Ïó∞Î†πÎåÄÎ≥Ñ Ïù∏Íµ¨ ÎπÑÏú® 

SELECT 
	A.AGRDE_SE_CD,
	A.AGRDE_POPLTN_CNT,
	A.AGRDE_POPLTN_CNT / SUM(A.AGRDE_SE_CD) OVER() AS AGRDE_POPLTN_RATE
FROM (
	SELECT 
		AGRDE_SE_CD,
		SUM(POPLTN_CNT) AS AGRDE_POPLTN_CNT
	FROM TB_POPLTN
	WHERE STD_MT='202304'
		AND ADMINIST_ZONE_NO LIKE '__00000000'
		AND POPLTN_SE_CD = 'T'
	GROUP BY AGRDE_SE_CD
	ORDER BY AGRDE_SE_CD) A;
```

```sql
-- ÏÑúÎ∏å ÏøºÎ¶¨ ÎåÄÏã† WITH ~ AS Íµ¨Î¨∏ ÏÇ¨Ïö©ÌïòÍ∏∞
-- WITH AS Íµ¨Î¨∏ : ÏÑúÎ∏åÏøºÎ¶¨ÏóêÏÑú Ï°∞ÌöåÌï† Í≤∞Í≥ºÎ•º ÎØ∏Î¶¨ ÏûÑÏãú ÌÖåÏù¥Î∏î ÌòïÏãùÏúºÎ°ú ÎßåÎì§Ïñ¥ ÎÜìÎäî Î∞©Î≤ï,
-- 				ÏûÑÏãú ÌÖåÏù¥Î∏îÏù¥Í∏∞ ÎïåÎ¨∏Ïóê 1ÌöåÏÑ±, ÌïúÎ≤à ÏÇ¨Ïö©ÌïòÎ©¥ ÏÇ¨ÎùºÏßÑÎã§. VIEWÏôÄ Îã§Î¶Ñ !!! 
-- Î∞òÎìúÏãú!!! SELECT Ï†àÍ≥º Ìï®Íªò~~~
WITH TEMP_AGRDE_POPLTN_CNT AS(
	SELECT 
		AGRDE_SE_CD,
		SUM(POPLTN_CNT) AS AGRDE_POPLTN_CNT
	FROM TB_POPLTN
	WHERE STD_MT='202304'
		AND ADMINIST_ZONE_NO LIKE '__00000000'
		AND POPLTN_SE_CD = 'T'
	GROUP BY AGRDE_SE_CD
	ORDER BY AGRDE_SE_CD
)
SELECT 
	AGRDE_SE_CD,
	AGRDE_POPLTN_CNT,
	AGRDE_POPLTN_CNT / SUM(AGRDE_POPLTN_CNT) OVER () AGRDE_POPLTN_RATE
FROM TEMP_AGRDE_POPLTN_CNT;
```

```sql
-- 2023ÎÖÑ 4Ïõî Í∏∞Ï§Ä Ï†ÑÍµ≠ Ï£ºÏöî Ïãú/ÎèÑÏùò ÏÑ±Î≥Ñ(M, F) Ïù∏Íµ¨Ïàò Ìï©Í≥Ñ
SELECT
	POPLTN_SE_CD,
	SUM(POPLTN_CNT) AS SE_POPLTN_CNT
FROM TB_POPLTN
WHERE STD_MT = '202304'
	AND ADMINIST_ZONE_NO LIKE '__00000000'
	AND POPLTN_SE_CD IN ('M', 'F')
GROUP BY POPLTN_SE_CD;
```
```sql
-- ÎÇ®ÏÑ± / Ïó¨ÏÑ± ÎπÑÏú® Íµ¨ÌïòÍ∏∞
-- ÎÇ®Ïûê : Ïó¨Ïûê ÎπÑÏú® Íµ¨ÌïòÍ∏∞
-- ÎÇ®Ïûê / Ï†ÑÏ≤¥
-- Ïó¨Ïûê / Ï†ÑÏ≤¥ 

-- colum Î†àÎ≤®ÏóêÏÑú ÏÑ±Î≥ÑÏùÑ ÏÑ†ÌÉùÌï† Ïàò ÏûàÍ≤å ÎßåÎì§Í∏∞ ÏúÑÌï¥ 
-- CASE WHEN THENÏùÑ Ïù¥Ïö©Ìï¥ÏÑú PivotingÏùÑ ÏàòÌñâÌïúÎã§.
-- Ïôú? ÎÇ®Ïûê, Ïó¨Ïûê Ï†ïÎ≥¥Î•º SELECT Ìï¥Ïïº ÌïòÍ∏∞ ÎïåÎ¨∏!! 

SELECT
	POPLTN_SE_CD,
	CASE 
		WHEN POPLTN_SE_CD = 'M' THEN SUM(POPLTN_CNT)
		ELSE 0
	END AS MALE_POPLTN_CNT,
	CASE 
		WHEN POPLTN_SE_CD = 'F' THEN SUM(POPLTN_CNT)
		ELSE 0
	END AS FEMALE_POPLTN_CNT
FROM TB_POPLTN
WHERE STD_MT = '202304'
	AND ADMINIST_ZONE_NO LIKE '__00000000'
	AND POPLTN_SE_CD IN ('M', 'F')
GROUP BY POPLTN_SE_CD; 
```

```sql
-- ÌëúÏóê ÎçîÏù¥ÏÉÅ ÌïÑÏöîÏóÜÎäî F,M ÏóÜÏï†Í∏∞
WITH TEMP_SE_POPLTN_CNT AS (
	SELECT
	POPLTN_SE_CD,
	CASE WHEN POPLTN_SE_CD = 'M' THEN SUM(POPLTN_CNT) ELSE 0 END AS MALE_POPLTN_CNT,
	CASE WHEN POPLTN_SE_CD = 'F' THEN SUM(POPLTN_CNT) ELSE 0 END AS FEMALE_POPLTN_CNT
FROM TB_POPLTN
WHERE STD_MT = '202304'
	AND ADMINIST_ZONE_NO LIKE '__00000000'
	AND POPLTN_SE_CD IN ('M', 'F')
GROUP BY POPLTN_SE_CD 
), TEMP_PIVOT_POPLTN_CNT AS (
	SELECT
		MAX(MALE_POPLTN_CNT) AS MALE_POPLTN_CNT,
		MAX(FEMALE_POPLTN_CNT) AS FEMALE_POPLTN_CNT
	FROM TEMP_SE_POPLTN_CNT
)SELECT 
	MALE_POPLTN_CNT, FEMALE_POPLTN_CNT,
	MALE_POPLTN_CNT / FEMALE_POPLTN_CNT AS "ÎÇ®ÏÑ±/Ïó¨ÏÑ± ÎπÑÏú®",
	MALE_POPLTN_CNT / (MALE_POPLTN_CNT + FEMALE_POPLTN_CNT ) AS "Ï†ÑÏ≤¥Ïù∏Íµ¨ÏàòÎåÄÎπÑÎÇ®ÏÑ±ÎπÑÏú®",
	FEMALE_POPLTN_CNT / (MALE_POPLTN_CNT + FEMALE_POPLTN_CNT ) AS "Ï†ÑÏ≤¥Ïù∏Íµ¨ÏàòÎåÄÎπÑÏó¨ÏÑ±ÎπÑÏú®"
FROM TEMP_PIVOT_POPLTN_CNT;
```

```SQL
-- -- -- -- -- -- -- --
-- -- 25-02-06-THU -- --

-- Ïó∞Î†πÎåÄ Î≥Ñ Ïù∏Íµ¨Í∞Ä Í∞ÄÏû• ÎßéÏùÄ ÏßÄÏó≠ Íµ¨ÌïòÍ∏∞
-- 2023ÎÖÑ 4Ïõî Í∏∞Ï§Ä Ï†ÑÍµ≠Ïùò Ïùç/Î©¥/ÎèôÎ≥Ñ Ï†ÑÏ≤¥ Ïù∏Íµ¨Ïàò Ï°∞Ìöå

USE analyze_db; 

SELECT
    AGRDE_SE_CD,
    ADMINIST_ZONE_NO,
    ADMINIST_ZONE_NM,
    POPLTN_CNT
FROM TB_POPLTN
WHERE POPLTN_SE_CD = 'T'
  AND STD_MT = '202304'
  AND POPLTN_CNT > 0
  AND ADMINIST_ZONE_NO NOT LIKE '_____00000'
ORDER BY POPLTN_CNT DESC
```

```SQL
-- ÎÇ¥Î¶ºÏ∞®ÏàúÏúºÎ°ú rank Î®πÏó¨ÏÑú 1Îì±Ïù∏ Í≥≥Ïù¥ Ïñ¥Ï®åÎì† ÏµúÎåÄÍ∞íÏù¥Í≤†ÏßÄ? 
-- ÏßëÍ≥Ñ ÎåÄÏÉÅ Í∞í!Ïù¥ Ï§ëÏöîÌïòÎ©¥ GROUP BYÎ•º ÏÇ¨Ïö©ÌïòÎäî Í≤ÉÏù¥Í≥†,
-- Ïö∞Î¶¨Í∞Ä Î≥¥Í≥†Ïûê ÌïòÎäî Í±¥ Í∞ÄÏû• ÎßéÏùÄ ÎèôÎÑ§!!Í∞Ä Ï§ëÏöîÌïú Í±∞Í∏∞ ÎïåÎ¨∏Ïóê
-- window function ÏùÑ Ïì∞Îäî Í≤å Îçî ÎÇ´Îã§. 
WITH TEMP_EMD_POPLTN_CNT AS(
    SELECT
        AGRDE_SE_CD, -- Ïó∞Î†πÎåÄÎ≥Ñ
        ADMINIST_ZONE_NO, -- ÏãúÍµ∞Íµ¨ Î≤àÌò∏
        ADMINIST_ZONE_NM, -- ÏãúÍµ∞Íµ¨ Ïù¥Î¶Ñ
        POPLTN_CNT -- Ïù∏Íµ¨ Ï¥ùÌï©
    FROM TB_POPLTN
    WHERE POPLTN_SE_CD = 'T'
      AND STD_MT = '202304'
      AND POPLTN_CNT > 0
      AND ADMINIST_ZONE_NO NOT LIKE '_____00000'
    ORDER BY POPLTN_CNT DESC
), TEMP_AGRDE_POPLTN_RANK AS(
    SELECT
        AGRDE_SE_CD,
        ADMINIST_ZONE_NO,
        ADMINIST_ZONE_NM,
        POPLTN_CNT,
        RANK() OVER(PARTITION BY AGRDE_SE_CD ORDER BY POPLTN_CNT DESC) AS POPLTN_RANK
    FROM TEMP_EMD_POPLTN_CNT
)
SELECT *
FROM TEMP_AGRDE_POPLTN_RANK
WHERE POPLTN_RANK = 1
ORDER BY AGRDE_SE_CD;

```

```SQL
-- #############################
-- Ïó∞Î†πÎåÄ Î≥Ñ Ïù∏Íµ¨ ÎπÑÏú®Ïù¥ Í∞ÄÏû• ÎÜíÏùÄ ÏßÄÏó≠ Ï∞æÍ∏∞
--  ÎèôÎÑ§ Î≥Ñ Ïó∞Î†πÎåÄ ÎπÑÏú® Íµ¨ÌïòÍ∏∞ -> Í∑∏ ÎπÑÏú®Ïù¥ Ïó∞Î†πÎåÄ Î≥ÑÎ°ú 1ÏúÑÏù∏ ÏßÄÏó≠Îßå Íµ¨ÌïòÍ∏∞ 

WITH TEMP_EMD_POPLTN_CNT AS(
	SELECT
	    AGRDE_SE_CD,
	    ADMINIST_ZONE_NO,
	    ADMINIST_ZONE_NM,
	    POPLTN_CNT
	FROM TB_POPLTN
	WHERE POPLTN_SE_CD = 'T'
	  AND STD_MT = '202304'
	  AND POPLTN_CNT > 0
	  AND ADMINIST_ZONE_NO NOT LIKE '_____00000'
	ORDER BY POPLTN_CNT DESC
), TEMP_AGRDE_RATE AS(
	SELECT
		*,
		POPLTN_CNT / SUM(POPLTN_CNT) OVER(PARTITION BY ADMINIST_ZONE_NO) AS "ÏßÄÏó≠Î≥ÑÏó∞Î†πÎåÄÎπÑÏú®"
	FROM TEMP_EMD_POPLTN_CNT
), TEMP_AGRDE_RATE_RANK AS(
	SELECT
		*,
		RANK() OVER(PARTITION BY AGRDE_SE_CD ORDER BY ÏßÄÏó≠Î≥ÑÏó∞Î†πÎåÄÎπÑÏú® DESC) AS POPLTN_RATE_RANK
	FROM TEMP_AGRDE_RATE
)
SELECT *
FROM TEMP_AGRDE_RATE_RANK 
WHERE POPLTN_RATE_RANK = 1
ORDER BY AGRDE_SE_CD;
```

# Ïù¥Ìï¥ Ìï¥Î≥¥Ïûê
```SQL
-- group by -> Ïà´ÏûêÍ∞Ä Ï§ëÏöî, max, min
-- rank -> Ïà´ÏûêÎ≥¥Îã® Ï£ºÎ≥Ä Ï†ïÎ≥¥(ÎèôÎÑ§Ïù¥Î¶Ñ)

-- #####################################################
-- ############# Ïù¥Ï†ïÎèÑ ÌíÄÏ§Ñ ÏïåÎ©¥ Ï∂©Î∂ÑÌï®....... ###############
-- #####################################################

-- ÏàôÏ†ú 1) 2023ÎÖÑ 4Ïõî Ï†ÑÍµ≠Ïùò Í∞Å Ïùç/Î©¥/Îèô Í∏∞Ï§Ä ÎÇ®ÏÑ±Ïùò ÏàòÎ≥¥Îã§ Ïó¨ÏÑ±Ïùò ÏàòÍ∞Ä ÎßéÏùÄ ÏßÄÏó≠ Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú

SHOW tables

WITH
    TEMP_SE_REDUCE AS (
        SELECT ADMINIST_ZONE_NO,
               ADMINIST_ZONE_NM,
               POPLTN_SE_CD,
               SUM(POPLTN_CNT) AS POPLTN_CNT
        FROM TB_POPLTN
        WHERE ADMINIST_ZONE_NO NOT LIKE '_____00000'
          AND POPLTN_SE_CD IN ('M', 'F')
          AND STD_MT = '202304'
        GROUP BY ADMINIST_ZONE_NO, ADMINIST_ZONE_NM, POPLTN_SE_CD
    ),
    TEMP_SE_PIVOT AS(
        SELECT
            ADMINIST_ZONE_NO,
            ADMINIST_ZONE_NM,
            IF(POPLTN_SE_CD = 'M', POPLTN_CNT, 0) AS MALE_POPLTN_CNT,
            IF(POPLTN_SE_CD = 'F', POPLTN_CNT, 0) AS FEMALE_POPLTN_CNT
        FROM TEMP_SE_REDUCE
    ),
    TEMP_ADMINIST_PIVOT AS (
        SELECT
            ADMINIST_ZONE_NO, ADMINIST_ZONE_NM,
            MAX(MALE_POPLTN_CNT) AS MALE_POPLTN_CNT,
            MAX(FEMALE_POPLTN_CNT) AS FEMALE_POPLTN_CNT
        FROM TEMP_SE_PIVOT
        GROUP BY ADMINIST_ZONE_NO, ADMINIST_ZONE_NM
    )
SELECT
    ADMINIST_ZONE_NO,
    ADMINIST_ZONE_NM,
    FEMALE_POPLTN_CNT,
    MALE_POPLTN_CNT,
    FEMALE_POPLTN_CNT - MALE_POPLTN_CNT AS FEMALE_MALE_DIFF
FROM TEMP_ADMINIST_PIVOT
ORDER BY FEMALE_MALE_DIFF DESC
LIMIT 10;
```
```SQL
-- ÏàôÏ†ú 2)
-- ÎÇ®ÏÑ±/Ïó¨ÏÑ± ÎπÑÏú®Ïù¥ Í∞ÄÏû• ÎÜíÏùÄ ÏßÄÏó≠Í≥º Í∞ÄÏû• ÎÇÆÏùÄ ÏßÄÏó≠ Íµ¨ÌïòÍ∏∞
--  Ï†ÑÍµ≠Ïùò Í∞Å Ïùç/Î©¥/Îèô Í∏∞Ï§Ä ÎÇ®ÏÑ± ÎπÑÏú® Î∞è Ïó¨ÏÑ± ÎπÑÏú®Ïù¥ Í∞ÄÏû• ÎÜíÍ±∞ÎÇò ÎÇÆÏùÄ ÏßÄÏó≠ Íµ¨ÌïòÍ∏∞.
--   ÎπÑÏú® : AÎùºÎäî ÎèôÎÑ§Ïóê ÎÇ®ÏÑ±Ïù¥ 100Î™Ö, Ïó¨ÏÑ±Ïù¥ 130Î™ÖÏù¥Î©¥ ÎÇ®ÏÑ± ÎπÑÏú® : 100/(100+130) Ïó¨ÏÑ± ÎπÑÏú® : 130 / (100+130)

WITH TEMP_POPLTN_CNT AS (
    SELECT
        A.ADMINIST_ZONE_NO,
        A.ADMINIST_ZONE_NM,
        A.POPLTN_SE_CD,
        SUM(A.POPLTN_CNT) AS POPLTN_CNT
    FROM TB_POPLTN A
    WHERE A.ADMINIST_ZONE_NO NOT LIKE '_____00000'
      AND A.POPLTN_SE_CD IN ('M', 'F')
      AND A.STD_MT = '202304'
      AND A.POPLTN_CNT > 0
    GROUP BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.POPLTN_SE_CD
    ORDER BY A.ADMINIST_ZONE_NO, A.POPLTN_SE_CD
), TEMP_SE_CNT_PIVOT AS (
    SELECT ADMINIST_ZONE_NO,
           ADMINIST_ZONE_NM,
           CASE WHEN POPLTN_SE_CD = 'M' THEN POPLTN_CNT ELSE 0 END AS MALE_POPLTN_CNT,
           CASE WHEN POPLTN_SE_CD = 'F' THEN POPLTN_CNT ELSE 0 END AS FEMALE_POPLTN_CNT
    FROM TEMP_POPLTN_CNT
), TEMP_SE_CNT_PIVOT_REDUCE AS (
    SELECT ADMINIST_ZONE_NO,
           ADMINIST_ZONE_NM,
           MAX(MALE_POPLTN_CNT) AS MALE_POPLTN_CNT,
           MAX(FEMALE_POPLTN_CNT) AS FEMALE_POPLTN_CNT,
           MAX(MALE_POPLTN_CNT) + MAX(FEMALE_POPLTN_CNT) AS TOT_POPLTN_CNT
    FROM TEMP_SE_CNT_PIVOT
    GROUP BY ADMINIST_ZONE_NO, ADMINIST_ZONE_NM
), TEMP_SE_CNT_RATE AS (
    SELECT
        ADMINIST_ZONE_NO,
        ADMINIST_ZONE_NM,
        MALE_POPLTN_CNT,
        FEMALE_POPLTN_CNT,
        MALE_POPLTN_CNT / TOT_POPLTN_CNT AS "ÎÇ®ÏÑ±Ïù∏Íµ¨ÎπÑÏú®",
        FEMALE_POPLTN_CNT / TOT_POPLTN_CNT AS "Ïó¨ÏÑ±Ïù∏Íµ¨ÎπÑÏú®",
        RANK() OVER( ORDER BY MALE_POPLTN_CNT / TOT_POPLTN_CNT ) AS MALE_RATE_ASC, -- ÎÇ®ÏÑ± Ïù∏Íµ¨ ÎπÑÏú® Ïò§Î¶ÑÏ∞®Ïàú Îû≠ÌÇπ
        RANK() OVER( ORDER BY FEMALE_POPLTN_CNT / TOT_POPLTN_CNT ) AS FEMALE_RATE_ASC, -- Ïó¨ÏÑ± Ïù∏Íµ¨ ÎπÑÏú® Ïò§Î¶ÑÏ∞®Ïàú Îû≠ÌÇπ
        RANK() OVER( ORDER BY MALE_POPLTN_CNT / TOT_POPLTN_CNT DESC) AS MALE_RATE_DESC, -- ÎÇ®ÏÑ± Ïù∏Íµ¨ ÎπÑÏú® ÎÇ¥Î¶ºÏ∞®Ïàú Îû≠ÌÇπ
        RANK() OVER( ORDER BY FEMALE_POPLTN_CNT / TOT_POPLTN_CNT DESC) AS FEMALE_RATE_DESC -- Ïó¨ÏÑ± Ïù∏Íµ¨ ÎπÑÏú® ÎÇ¥Î¶ºÏ∞®Ïàú Îû≠ÌÇπ
    FROM TEMP_SE_CNT_PIVOT_REDUCE
)
SELECT
    ADMINIST_ZONE_NO,
    ADMINIST_ZONE_NM,
    MALE_POPLTN_CNT,
    FEMALE_POPLTN_CNT,
    ÎÇ®ÏÑ±Ïù∏Íµ¨ÎπÑÏú®,
    Ïó¨ÏÑ±Ïù∏Íµ¨ÎπÑÏú®
FROM TEMP_SE_CNT_RATE
WHERE MALE_RATE_ASC = 1 OR FEMALE_RATE_ASC = 1 OR MALE_RATE_DESC = 1 OR FEMALE_RATE_DESC = 1;

```

üìå‚úÖ1Ô∏è‚É£üéØ
