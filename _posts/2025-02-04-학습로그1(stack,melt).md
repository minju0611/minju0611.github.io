---
layout : post
title : "Pandas의 데이터 집계(stack, melt, pivot)"

categories:
  - learning log
tags:
  - [memo]

toc: true
toc_sticky: true
 
date: 2025-02-04 15:52:00 +0900
---

학습 로그
```
제목 
Pandas의 데이터 집계 - Stack, Melt, Pivot

계기
- 수업시간에 배운 stack, melt, pivot이 사용되는 용도를 잘 모르겠다.
- 그중에서도 stack과 melt의 차이점을 잘 모르겠다.
- 단순한 DataFrame을 생성하여 적용해보며 이해해보자.

내용
- stack, melt, pivot이란?
- stack과 melt의 차이점이 무엇인가

링크
- 참고 블로그
- 내 블로그 

```
stack, unstack, melt, pivot
***
알아보기에 앞서 간단한 DataFrame을 생성한다.
```python
import pandas as pd

df = pd.DataFrame({
    "이름": ["철수", "영희", "민주", "은수"],
    "반" : ["A", "A", "B", "B"],
    "국어": [90, 85, 12, 100],
    "수학": [88, 92, 50, 90],
    "영어": [55, 90, 84, 72]
})
df
```
`[출력]`  
![](/images/../images/2025-02-05-22-09-27.png)

df의 index와 columns을 확인해보자!
```python
# index 정보 확인
df.index
```
`[출력]`  
RangeIndex(start=0, stop=4, step=1)
```python
# columns 정보 확인
df.columns
```
`[출력]`   
Index(['이름', '반', '국어', '수학', '영어'], dtype='object')

즉, index는 0~3이고 columns은 '이름', '반', '국어', '수학', '영어'로 이루어진 DataFrame이다.

해당 df를 사용하여 pivot, stack, unstack, melt에 대해 자세히 이해해보자!

## pivot_table
- 컬럼에 있는 걸 index, columns, values, aggfunc을 지정해서 집계
- 컬럼의 값만을 지정할 수 있다.

#### pivot_table 생성 형식
```python
df_pivot = pd.pivot_table(
    df,
    index = "A",       # 행 인덱스로 사용할 컬럼
    columns = "B",     # 열(컬럼)으로 사용할 컬럼
    values = "C",       # 값으로 사용할 컬럼
    aggfunc = "mean"  # 값을 집계할 함수
)
```
#### pivot_table을 이용해 반 별 전체 과목 평균, 최소, 최대 값을 구해보자.
```python
# 반 별 과목 평균, 최소, 최대
df_pivot = pd.pivot_table(
    df,
    index = '반',
    values = ['국어','수학', '영어'],
    aggfunc = ['mean', 'min', 'max']
)
df_pivot
```
`[출력]`  
![](/images/../images/2025-02-05-22-11-30.png)

#### index와 columns를 확인해보자
```python
df_pivot.index
```
`[출력]`  
Index(['A', 'B'], dtype='object', name='반')

```python
df_pivot.columns
```

`[출력]`
```
MultiIndex([('mean', '국어'),
            ('mean', '수학'),
            ('mean', '영어'),
            ( 'min', '국어'),
            ( 'min', '수학'),
            ( 'min', '영어'),
            ( 'max', '국어'),
            ( 'max', '수학'),
            ( 'max', '영어')],
           )
```
- columns에 MultiIndex가 생성되었다.
- columns의 MultiIndex level은 다음과 같다
- 표와 가까울수록 낮은 레벨(하위레벨), 멀 수록 높은 레벨(상위 레벨)이다.
![](/images/../images/2025-02-05-23-05-38.png)

## stack
- 표가 가로로 너무 길 경우, 세로로 길게 만들 수 있음
- 컬럼이 멀티인덱스일 때 
- 컬럼을 행 인덱스로 이동 (MultiIndex가 됨)
- 컬럼의 레벨단위로 인덱스로 내림 (따라서 멀티인덱스일 때 사용하기 좋음)
- 컬럼 레벨을 행 인덱스로 내린다.
- 집계를 하기 위한 기능은 아니다! (groupby와 다름)
- 멀티 인덱스를 가진 데이터에서 많이 활용된다.
- 결과적으로, 기존 데이터의 형태를 바꿔서 활용하기 쉽게 만든다.
- stack() 안에 컬럼 레벨을 지정하지 않으면 가장 하위레벨이 자동으로 stack()된다.
#### stack() 사용 형식

```python
# 지정된 컬럼 레벨이 행 인덱스로 stack()됨.
df.stack(컬럼레벨)
```

#### columns level을 stack을 활용해 row index로 쌓기
```python
# mean, min, max 컬럼을 행인덱스로
df_pivot.stack(0)
```
`[출력]`  
![](/images/../images/2025-02-05-22-45-30.png)

```python
# 국어, 수학, 영어 컬럼을 행인덱스로
df_pivot.stack()
```
`[출력]`  
![](/images/../images/2025-02-05-22-44-35.png)


#### df_stack 생성
```python
df_stack = df_pivot.stack()
```
#### index와 columns를 확인해보자
```python
df_stack.index
```
`[출력]`  
```
MultiIndex([('A', '국어'),
            ('A', '수학'),
            ('A', '영어'),
            ('B', '국어'),
            ('B', '수학'),
            ('B', '영어')],
           names=['반', None])
```
```python
df_stack.columns
```
`[출력]`  
Index(['mean', 'min', 'max'], dtype='object')

- 집계의 '집'은 행 인덱스만 가능하다.
- 멀티인덱스는 집계를 할 수 없다!
- 만약, 컬럼에 있는 값의 묶음으로 집계를 하고 싶다면, 행 인덱스로 변화를 줘야한다.
- 그러나 stack은 행으로 내릴 떄, 기존의 인덱스와 겹쳐서 멀티인덱스로 만들기 때문에 적절한 방법이 아니다.
- 이런 경우에는 melt()를 사용하는 것이 좋다.  

## unstack()
- stack()의 반대개념이다.
- stack()을 실행한 DataFrame을 unstack()하면 처음 형태가 된다.

#### unstack() 사용 형식
```python
df.unstack(행 인덱스 레벨)
```
#### unstack()으로 다시 돌려 놓기
```python
df_stack.unstack()
```
`[출력]`   
![](/images/../images/2025-02-05-23-18-42.png)
- 행 인덱스의 가장 하위레벨이었던 '국어', '수학', '영어'가 컬럼인덱스의 가장 하위레벨이 되었다.

## melt

- 기준을 잡은 컬럼들을 제외하고, 남은 컬럼들을 하나의 컬럼으로 녹임.
  - 녹일 컬럼을 직접 정할 수 있음
- stack은 컬럼을 행인덱스로 변화하는 것이고, melt는 컬럼들을 기준에 맞춰 하나의 컬럼으로 녹이는 것이다.

#### melt() 사용법
```python
pd.melt(
  df,
  id_vars=[고정할 컬럼], value_vars=[녹일 컬럼], var_name="새 컬럼 이름", value_name="새 값 컬럼 이름")

```
#### melt()를 사용하여 국어, 수학, 영어를 과목이라는 하나의 컬럼으로 녹이기
```python
df_melt = df.melt(
    id_vars=['이름', '반'],
    var_name = '과목',
    value_name = '점수'
)
df_melt
```
`[출력]`  
![](/images/../images/2025-02-05-23-52-25.png)
- '국어', '수학', '영어'가 '과목'이라는 컬럼 하나로 녹았다.
- '국어', '수학', '영어'의 값은 '점수' 컬럼에 녹았다.
- 이제 과목별로 집계가 가능해졌다!
  #### 과목별 점수 평균 집계
  ```python
  df_t = df_melt.groupby("과목").mean(numeric_only=True) 
  df_t
  ```
  `[출력]`  
  ![](/images/../images/2025-02-05-23-55-09.png)



```
집계 - 데이터를 모으고 reduction 
그룹핑된 데이터를 하나의 값으로 계산하는 과정 
그룹 안에 있는 데이터를 하나로 만들어주는
따라서 집계의 결과는 무조건 한 개! - reductions
```